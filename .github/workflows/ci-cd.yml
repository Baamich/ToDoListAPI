name: CI/CD Pipeline

on:
  push:
    branches:
      - CI/CD

jobs:
  build-and-push:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout репозиторий
        uses: actions/checkout@v4

      - name: Вход в Docker Hub
        run: echo "${{ secrets.DOCKERHUB_TOKEN }}" | docker login -u "${{ secrets.DOCKERHUB_USERNAME }}" --password-stdin

      - name: Сборка и пуш API
        run: |
          docker build -t ${{ secrets.DOCKERHUB_USERNAME }}/todo_api:latest -f ToDoListAPI/Dockerfile .
          docker push ${{ secrets.DOCKERHUB_USERNAME }}/todo_api:latest

      - name: Сборка и пуш Blazor
        run: |
          docker build -t ${{ secrets.DOCKERHUB_USERNAME }}/todo_blazor:latest -f ToDoListBlazor/Dockerfile .
          docker push ${{ secrets.DOCKERHUB_USERNAME }}/todo_blazor:latest

  test-containers:
    needs: build-and-push
    runs-on: ubuntu-latest
    steps:
      - name: Создание сети (если не существует)
        run: docker network create todo_network || true

      - name: Запуск контейнеров
        run: |
          docker run -d --name todo_api --network todo_network -p 8090:8090 ${{ secrets.DOCKERHUB_USERNAME }}/todo_api:latest
          docker run -d --name todo_blazor --network todo_network -p 8091:80 ${{ secrets.DOCKERHUB_USERNAME }}/todo_blazor:latest

      - name: Проверка API
        run: |
          sleep 10
          curl -f http://todo_api:8090/api/tasks/health || exit 1
          curl -f http://todo_blazor:80 || exit 1

      - name: Остановка и очистка контейнеров
        run: docker stop todo_api todo_blazor && docker rm todo_api todo_blazor
